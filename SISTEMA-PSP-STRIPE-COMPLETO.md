# üè¶ Sistema PSP com Stripe - Guia Completo

## üìã √çndice
1. [O que √© um PSP e como funciona](#o-que-√©-um-psp)
2. [Implementa√ß√£o Atual](#implementa√ß√£o-atual)
3. [Limita√ß√µes da Implementa√ß√£o Atual](#limita√ß√µes-da-implementa√ß√£o-atual)
4. [Stripe Connect - Solu√ß√£o Profissional](#stripe-connect)
5. [Como Migrar para Stripe Connect](#como-migrar)
6. [Compara√ß√£o: Implementa√ß√£o Atual vs. Stripe Connect](#compara√ß√£o)

---

## üéØ O que √© um PSP e como funciona

Um **PSP (Payment Service Provider)** √© uma plataforma que faz a intermedia√ß√£o de pagamentos entre compradores e vendedores, cobrando uma taxa sobre as transa√ß√µes.

### Fluxo t√≠pico:
```
Cliente ‚Üí [Plataforma PSP] ‚Üí Profissional
    R$ 100,00 ‚Üí R$ 5,00 (taxa) ‚Üí R$ 95,00
```

### Responsabilidades de um PSP:
- ‚úÖ Processar pagamentos com seguran√ßa
- ‚úÖ Reter comiss√µes automaticamente
- ‚úÖ Distribuir valores aos profissionais
- ‚úÖ Gerenciar disputas e chargebacks
- ‚úÖ Cumprir regulamenta√ß√µes financeiras

---

## üìä Implementa√ß√£o Atual

### ‚úÖ O que est√° funcionando:

#### 1. **C√°lculo de Comiss√£o**
```typescript
// server/routes-simple.ts (linha 625-626)
const lifebeeCommission = finalAmount * 0.05; // 5% de comiss√£o
const professionalAmount = finalAmount - lifebeeCommission;
```

#### 2. **Payment Intent com Metadata**
```typescript
// server/routes-simple.ts (linha 642-654)
const paymentIntent = await stripe.paymentIntents.create({
  amount: Math.round(finalAmount * 100),
  currency: 'brl',
  payment_method_types: ['card'],
  metadata: {
    serviceOfferId: serviceOffer.id.toString(),
    serviceRequestId: serviceOffer.serviceRequestId.toString(),
    clientId: serviceRequest.clientId.toString(),
    professionalId: serviceOffer.professionalId.toString(),
    lifebeeCommission: lifebeeCommission.toFixed(2),      // ‚úÖ Registrado
    professionalAmount: professionalAmount.toFixed(2),    // ‚úÖ Registrado
  },
});
```

#### 3. **Webhook para Confirma√ß√£o**
```typescript
// server/routes-simple.ts (linha 353-396)
case 'payment_intent.succeeded':
  const paymentIntent = event.data.object;
  // Atualiza status do servi√ßo
  await storage.updateServiceOfferStatus(parseInt(serviceOfferId), 'completed');
  // Cria notifica√ß√£o para o profissional
  await storage.createNotification({
    userId: parseInt(professionalId),
    type: 'payment_received',
    title: 'Pagamento Recebido! üí∞',
    message: `Seu pagamento de R$ ${(paymentIntent.amount / 100).toFixed(2)} foi aprovado.`,
  });
```

### ‚ö†Ô∏è Pontos de Aten√ß√£o:

1. **O dinheiro vai todo para a conta LifeBee**
   - Cliente paga R$ 100,00
   - Todo o valor vai para a conta Stripe da LifeBee
   - Sistema apenas "registra" que R$ 95,00 √© do profissional

2. **Transfer√™ncia manual necess√°ria**
   - LifeBee precisa transferir manualmente R$ 95,00 para o profissional
   - N√£o h√° automa√ß√£o no repasse
   - Profissional n√£o recebe automaticamente

3. **Compliance e regulamenta√ß√£o**
   - LifeBee est√° mantendo dinheiro de terceiros
   - Pode precisar de licen√ßa de institui√ß√£o de pagamento
   - Riscos legais e fiscais

---

## üö® Limita√ß√µes da Implementa√ß√£o Atual

### ‚ùå Problemas T√©cnicos:

1. **Sem Split Autom√°tico**
   - Valor total vai para LifeBee
   - Requer processo manual de repasse
   - Alto custo operacional

2. **Sem Gest√£o de Saldo**
   - N√£o h√° tracking de quanto cada profissional tem a receber
   - Dificulta concilia√ß√£o financeira
   - Propenso a erros humanos

3. **Sem Prote√ß√£o contra Chargebacks**
   - Se cliente pedir estorno, LifeBee perde todo o valor
   - Mesmo se j√° repassou ao profissional
   - Risco financeiro alto

### ‚öñÔ∏è Problemas Legais:

1. **Regulamenta√ß√£o Financeira**
   - Manter dinheiro de terceiros requer licen√ßa
   - LifeBee n√£o √© uma institui√ß√£o financeira
   - Pode ter problemas com Banco Central

2. **Responsabilidade Fiscal**
   - LifeBee precisa emitir nota fiscal de todo o valor?
   - Como declarar valores que s√£o do profissional?
   - Complexidade tribut√°ria alta

3. **Disputas e Estornos**
   - Quem √© respons√°vel por estornos?
   - Como lidar com disputas cliente-profissional?
   - Sem prote√ß√£o do Stripe

---

## üéâ Stripe Connect - Solu√ß√£o Profissional

O **Stripe Connect** √© a solu√ß√£o oficial do Stripe para marketplaces e plataformas que conectam compradores e vendedores.

### üåü Vantagens:

#### 1. **Split Autom√°tico de Pagamento**
```typescript
const paymentIntent = await stripe.paymentIntents.create({
  amount: 10000,  // R$ 100,00
  currency: 'brl',
  application_fee_amount: 500,  // R$ 5,00 (5%) vai para LifeBee
  transfer_data: {
    destination: professionalStripeAccountId,  // R$ 95,00 vai direto para profissional
  },
});
```

**Como funciona:**
```
Cliente paga R$ 100,00
    ‚Üì
Stripe divide automaticamente:
    ‚Üí R$ 5,00 para conta LifeBee
    ‚Üí R$ 95,00 para conta do Profissional
```

#### 2. **Profissionais t√™m suas pr√≥prias contas Stripe**
- Cada profissional cria uma conta Stripe Connect
- Dinheiro vai direto para conta deles
- LifeBee n√£o mant√©m dinheiro de terceiros
- Conforme a lei!

#### 3. **Prote√ß√£o contra Chargebacks**
- Se cliente pedir estorno, Stripe gerencia
- Pode reverter do profissional automaticamente
- LifeBee n√£o perde dinheiro

#### 4. **Compliance Autom√°tico**
- Stripe gerencia KYC (Know Your Customer)
- Stripe lida com regulamenta√ß√µes
- Stripe emite documentos fiscais
- LifeBee s√≥ cobra a comiss√£o

#### 5. **Dashboard para Profissionais**
- Profissionais acessam dashboard Stripe
- Veem seus ganhos em tempo real
- Fazem saques quando quiserem
- Transpar√™ncia total

---

## üõ†Ô∏è Como Migrar para Stripe Connect

### Passo 1: Criar Conta Stripe Connect

1. Acesse o Dashboard Stripe: https://dashboard.stripe.com/
2. V√° em **Connect** no menu lateral
3. Clique em **Get Started**
4. Escolha o tipo de integra√ß√£o:
   - **Standard** (recomendado para LifeBee)
   - **Express** (mais controle da LifeBee)
   - **Custom** (controle total)

### Passo 2: Atualizar Backend

#### 2.1. Criar endpoint para conectar profissionais

```typescript
// server/routes-simple.ts
app.post('/api/stripe/connect/create-account', authenticateToken, async (req, res) => {
  try {
    const user = req.user;
    const professional = await storage.getProfessionalByUserId(user.id);
    
    if (!professional) {
      return res.status(404).json({ error: 'Profissional n√£o encontrado' });
    }

    // Criar conta Connect para o profissional
    const account = await stripe.accounts.create({
      type: 'express',  // ou 'standard'
      country: 'BR',
      email: user.email,
      capabilities: {
        card_payments: { requested: true },
        transfers: { requested: true },
      },
      business_type: 'individual',
      metadata: {
        professionalId: professional.id.toString(),
        userId: user.id.toString(),
      },
    });

    // Salvar stripeAccountId no banco
    await storage.updateProfessional(professional.id, {
      stripeAccountId: account.id,
    });

    // Criar link para profissional completar cadastro
    const accountLink = await stripe.accountLinks.create({
      account: account.id,
      refresh_url: `${process.env.FRONTEND_URL}/settings?stripe_setup=failed`,
      return_url: `${process.env.FRONTEND_URL}/settings?stripe_setup=success`,
      type: 'account_onboarding',
    });

    res.json({
      success: true,
      accountId: account.id,
      onboardingUrl: accountLink.url,
    });
  } catch (error) {
    console.error('‚ùå Erro ao criar conta Connect:', error);
    res.status(500).json({ error: 'Erro ao criar conta Connect' });
  }
});
```

#### 2.2. Atualizar cria√ß√£o de Payment Intent

```typescript
// server/routes-simple.ts
app.post('/api/payment/create-intent', authenticateToken, async (req, res) => {
  try {
    const { serviceOfferId } = req.body;
    
    // Buscar dados (mesmo c√≥digo atual)
    const serviceOffer = await storage.getServiceOfferById(serviceOfferId);
    const serviceRequest = await storage.getServiceRequestById(serviceOffer.serviceRequestId);
    const professional = await storage.getProfessionalById(serviceOffer.professionalId);
    
    // Verificar se profissional tem conta Connect
    if (!professional.stripeAccountId) {
      return res.status(400).json({ 
        error: 'Profissional precisa conectar sua conta Stripe primeiro',
        needsStripeSetup: true,
      });
    }
    
    const amount = parseFloat(serviceOffer.finalPrice || serviceOffer.proposedPrice);
    const finalAmount = Math.max(amount, 5.00);
    
    // Calcular taxa LifeBee (5%)
    const lifebeeCommission = Math.round(finalAmount * 100 * 0.05); // em centavos
    
    // ‚ú® Criar Payment Intent com split autom√°tico
    const paymentIntent = await stripe.paymentIntents.create({
      amount: Math.round(finalAmount * 100),
      currency: 'brl',
      payment_method_types: ['card'],
      application_fee_amount: lifebeeCommission,  // ‚ú® Taxa LifeBee
      transfer_data: {
        destination: professional.stripeAccountId,  // ‚ú® Profissional recebe direto
      },
      metadata: {
        serviceOfferId: serviceOffer.id.toString(),
        serviceRequestId: serviceOffer.serviceRequestId.toString(),
        clientId: serviceRequest.clientId.toString(),
        professionalId: serviceOffer.professionalId.toString(),
      },
    });

    res.json({
      success: true,
      clientSecret: paymentIntent.client_secret,
    });
  } catch (error) {
    console.error('‚ùå Erro ao criar Payment Intent:', error);
    res.status(500).json({ error: 'Erro ao criar pagamento' });
  }
});
```

#### 2.3. Webhook j√° funciona! (n√£o precisa mudar muito)

```typescript
// server/routes-simple.ts
app.post('/api/payment/webhook', express.raw({type: 'application/json'}), async (req, res) => {
  // ... (c√≥digo de verifica√ß√£o atual)
  
  switch (event.type) {
    case 'payment_intent.succeeded':
      const paymentIntent = event.data.object;
      
      // ‚úÖ Dinheiro j√° foi dividido automaticamente pelo Stripe!
      // ‚úÖ R$ 5,00 j√° est√° na conta LifeBee
      // ‚úÖ R$ 95,00 j√° est√° na conta do Profissional
      
      // Apenas atualizar status no banco
      await storage.updateServiceOfferStatus(parseInt(serviceOfferId), 'completed');
      await storage.updateServiceRequestStatus(serviceRequest.id, 'completed');
      
      // Notificar profissional
      await storage.createNotification({
        userId: parseInt(professionalId),
        type: 'payment_received',
        title: 'Pagamento Recebido! üí∞',
        message: `Voc√™ recebeu R$ ${professionalAmount} pelo servi√ßo. O dinheiro j√° est√° em sua conta Stripe!`,
      });
      break;
  }
});
```

### Passo 3: Atualizar Banco de Dados

```sql
-- migrations/add_stripe_account_id.sql
ALTER TABLE professionals 
ADD COLUMN stripe_account_id VARCHAR(255) NULL,
ADD COLUMN stripe_onboarding_completed BOOLEAN DEFAULT FALSE;

CREATE INDEX idx_professionals_stripe_account 
ON professionals(stripe_account_id);
```

### Passo 4: Atualizar Frontend

#### 4.1. Adicionar bot√£o "Conectar Stripe" para profissionais

```typescript
// client/src/pages/provider-settings.tsx
import { Button } from "@/components/ui/button";

function ProviderSettings() {
  const [stripeAccountId, setStripeAccountId] = useState(null);
  const [loading, setLoading] = useState(false);

  const connectStripe = async () => {
    setLoading(true);
    try {
      const response = await fetch('/api/stripe/connect/create-account', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
        },
      });
      
      const data = await response.json();
      
      if (data.success) {
        // Redirecionar para p√°gina de onboarding do Stripe
        window.location.href = data.onboardingUrl;
      }
    } catch (error) {
      console.error('Erro ao conectar Stripe:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="p-6">
      <h2 className="text-2xl font-bold mb-4">Configura√ß√µes de Pagamento</h2>
      
      {!stripeAccountId ? (
        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <h3 className="font-semibold mb-2">‚ö†Ô∏è Configure sua conta Stripe</h3>
          <p className="text-sm text-gray-700 mb-4">
            Para receber pagamentos, voc√™ precisa conectar sua conta Stripe.
            √â r√°pido, seguro e gratuito!
          </p>
          <Button onClick={connectStripe} disabled={loading}>
            {loading ? 'Conectando...' : 'Conectar Stripe'}
          </Button>
        </div>
      ) : (
        <div className="bg-green-50 border border-green-200 rounded-lg p-4">
          <h3 className="font-semibold mb-2">‚úÖ Conta Stripe Conectada</h3>
          <p className="text-sm text-gray-700">
            Sua conta est√° ativa e pronta para receber pagamentos!
          </p>
        </div>
      )}
    </div>
  );
}
```

### Passo 5: Testar

1. **Como Profissional:**
   - Fazer login como profissional
   - Ir em Configura√ß√µes
   - Clicar em "Conectar Stripe"
   - Completar cadastro no Stripe
   - Voltar para plataforma

2. **Como Cliente:**
   - Fazer login como cliente
   - Aceitar uma proposta do profissional
   - Pagar com cart√£o de teste
   - Verificar se pagamento foi aprovado

3. **Verificar no Dashboard Stripe:**
   - Acessar https://dashboard.stripe.com/
   - Ir em "Connect > Accounts"
   - Ver conta do profissional criada
   - Ir em "Payments"
   - Ver pagamento com split (R$ 5,00 para voc√™, R$ 95,00 para profissional)

---

## üìä Compara√ß√£o: Implementa√ß√£o Atual vs. Stripe Connect

| Aspecto | Implementa√ß√£o Atual | Stripe Connect |
|---------|---------------------|----------------|
| **Split de pagamento** | ‚ùå Manual | ‚úÖ Autom√°tico |
| **Dinheiro de terceiros** | ‚ùå LifeBee mant√©m | ‚úÖ Vai direto para profissional |
| **Compliance legal** | ‚ö†Ô∏è Requer licen√ßa | ‚úÖ Stripe gerencia |
| **Chargebacks** | ‚ùå LifeBee assume risco | ‚úÖ Distribu√≠do automaticamente |
| **Repasse ao profissional** | ‚ùå Manual | ‚úÖ Instant√¢neo |
| **Dashboard profissional** | ‚ùå N√£o existe | ‚úÖ Stripe Dashboard |
| **Transpar√™ncia** | ‚ö†Ô∏è Limitada | ‚úÖ Total |
| **Custo operacional** | üü° Alto (manual) | üü¢ Baixo (autom√°tico) |
| **Escalabilidade** | ‚ùå Dif√≠cil | ‚úÖ Ilimitada |
| **Complexidade t√©cnica** | üü¢ Simples | üü° M√©dia |

---

## üí∞ Custos do Stripe Connect

### Stripe cobra:
- **2.9% + R$ 0.39** por transa√ß√£o com cart√£o (igual a implementa√ß√£o normal)
- **0.25%** adicional para Connect (muito baixo!)

### Exemplo com R$ 100,00:
```
Valor do servi√ßo: R$ 100,00
Taxa Stripe (2.9%): R$ 2,90
Taxa fixa Stripe: R$ 0,39
Taxa Connect (0.25%): R$ 0,25
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Total taxas Stripe: R$ 3,54

Valor l√≠quido: R$ 96,46
Comiss√£o LifeBee (5%): R$ 5,00
Profissional recebe: R$ 91,46
```

**Nota:** A comiss√£o LifeBee de 5% pode ser calculada sobre o valor bruto (antes das taxas Stripe) ou sobre o valor l√≠quido (depois das taxas). Isso √© uma decis√£o de neg√≥cio.

### Op√ß√£o 1: Comiss√£o sobre valor bruto (mais simples)
```typescript
// Cliente paga R$ 100,00
const amount = 10000; // centavos
const lifebeeCommission = Math.round(amount * 0.05); // R$ 5,00 (500 centavos)

const paymentIntent = await stripe.paymentIntents.create({
  amount: amount, // R$ 100,00
  application_fee_amount: lifebeeCommission, // R$ 5,00 vai para LifeBee
  // Profissional recebe: R$ 100,00 - R$ 3,54 (Stripe) - R$ 5,00 (LifeBee) = R$ 91,46
});
```

### Op√ß√£o 2: Profissional recebe exato (LifeBee paga taxas Stripe)
```typescript
// Profissional deve receber R$ 95,00 (95% de R$ 100,00)
const professionalAmount = 9500; // R$ 95,00 em centavos
const lifebeeCommission = 500; // R$ 5,00
const stripeFees = 354; // R$ 3,54 estimado

const totalAmount = professionalAmount + lifebeeCommission + stripeFees; // R$ 98,54
// Cliente paga R$ 98,54, profissional recebe exato R$ 95,00, LifeBee fica com R$ 1,46
```

**Recomenda√ß√£o:** Op√ß√£o 1 √© mais simples e transparente.

---

## üéØ Pr√≥ximos Passos Recomendados

### Curto Prazo (1-2 semanas):
1. ‚úÖ Implementar Stripe Connect
2. ‚úÖ Adicionar onboarding de profissionais
3. ‚úÖ Testar com profissionais reais
4. ‚úÖ Documentar processo para profissionais

### M√©dio Prazo (1 m√™s):
1. üìä Adicionar dashboard de ganhos para profissionais
2. üí≥ Implementar saques autom√°ticos
3. üìß Notifica√ß√µes de pagamento recebido
4. üîç Sistema de tracking de comiss√µes

### Longo Prazo (3 meses):
1. üåü Adicionar PIX via Stripe
2. üí∞ Implementar programa de cashback
3. üìà Analytics avan√ßado de pagamentos
4. üîê Sistema anti-fraude customizado

---

## üìö Recursos e Documenta√ß√£o

### Stripe Connect:
- **Documenta√ß√£o Oficial:** https://stripe.com/docs/connect
- **Guia de In√≠cio:** https://stripe.com/docs/connect/enable-payment-acceptance-guide
- **Best Practices:** https://stripe.com/docs/connect/best-practices
- **API Reference:** https://stripe.com/docs/api/accounts

### V√≠deos e Tutoriais:
- **Stripe Connect Overview:** https://www.youtube.com/watch?v=NNYqjJnc7KM
- **Building a Marketplace:** https://www.youtube.com/watch?v=6CFiSN5kNh8

### Comunidade:
- **Stack Overflow:** https://stackoverflow.com/questions/tagged/stripe-connect
- **Discord Stripe:** https://discord.gg/stripe

---

## ‚ùì FAQ - Perguntas Frequentes

### 1. A implementa√ß√£o atual est√° errada?
**R:** N√£o est√° "errada", mas n√£o √© a forma recomendada para um marketplace. Funciona para MVP, mas tem limita√ß√µes legais e operacionais.

### 2. Posso usar a implementa√ß√£o atual em produ√ß√£o?
**R:** Tecnicamente sim, mas voc√™ ter√° que:
- Fazer repasses manuais aos profissionais
- Gerenciar compliance financeiro
- Lidar com chargebacks manualmente
- Possivelmente obter licen√ßa de institui√ß√£o de pagamento

### 3. Stripe Connect √© muito mais caro?
**R:** N√£o! A taxa adicional √© de apenas 0.25%. Para um pagamento de R$ 100,00, s√£o apenas R$ 0,25 a mais.

### 4. √â dif√≠cil implementar Stripe Connect?
**R:** N√£o! O c√≥digo acima mostra que s√£o poucas mudan√ßas. A maioria do c√≥digo atual pode ser reaproveitado.

### 5. Profissionais precisam ter conta no Stripe?
**R:** Sim, mas √© muito simples. O Stripe Connect facilita o onboarding. O profissional s√≥ precisa fornecer:
- Nome completo
- CPF
- Dados banc√°rios
- E-mail

O processo leva menos de 5 minutos.

### 6. Como funciona a aprova√ß√£o do profissional?
**R:** O Stripe faz a verifica√ß√£o KYC automaticamente. Se aprovado, o profissional j√° pode receber pagamentos. Se houver algum problema, o Stripe notifica.

### 7. Posso mudar a taxa de comiss√£o depois?
**R:** Sim! A taxa √© configurada em cada Payment Intent. Voc√™ pode ter taxas diferentes para diferentes servi√ßos ou profissionais.

### 8. E se um profissional quiser sair da plataforma?
**R:** O profissional pode desconectar sua conta Stripe a qualquer momento. Os pagamentos pendentes ainda ser√£o processados.

---

## üéâ Conclus√£o

### Status Atual:
- ‚úÖ **Implementa√ß√£o b√°sica funcionando**
- ‚ö†Ô∏è **Split manual de pagamentos**
- ‚ö†Ô∏è **Riscos legais e operacionais**

### Recomenda√ß√£o:
- üöÄ **Migrar para Stripe Connect o quanto antes**
- ‚úÖ **Benef√≠cios superam largamente o esfor√ßo**
- üí∞ **Custo adicional √© m√≠nimo (0.25%)**
- ‚öñÔ∏è **Compliance e legalidade garantidos**

### Esfor√ßo estimado de migra√ß√£o:
- **Backend:** 4-6 horas
- **Frontend:** 2-3 horas
- **Testes:** 2-3 horas
- **Total:** ~1-2 dias de trabalho

**Vale muito a pena! üéâ**

---

## üìû Suporte

Se tiver d√∫vidas sobre a implementa√ß√£o, consulte:
1. Esta documenta√ß√£o
2. Documenta√ß√£o oficial do Stripe
3. Exemplos de c√≥digo no GitHub
4. Suporte do Stripe (responde r√°pido!)

**Boa sorte com a implementa√ß√£o! üöÄ**

